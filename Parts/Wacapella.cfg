
// ----------------------------------------------------------------------------
// Provides the Wacapella sounding rocket by modifying and duplicating parts 
// from CNAR and Taerobee mods.
//
// By: 610yesnolovely
// ----------------------------------------------------------------------------

+PART[tbee-taerobee-parachute]:AFTER[Spacelines_Tree]
{
	@name = CapellaParachute_Taerobee
	@TechRequired = start
	@rescaleFactor = 0.5

	@entryCost = 0
	@cost = 200
	@title = WAC Corporal Inline Parachute
	@description = Very small inline parachute module goes underneath WAC Corporal Control Unit, to carry the entire rocket safely back to the ground. Open this at very high altitudes around apogee, using it like a drogue chute, otherwise your rocket will be going too fast in the lower atmosphere. If the parachute snaps at high speed, alternatives might be to use a Communotron 4-S and transmit the science and not have a parachute, or try different fuel loads and trajectories. Early sounding rockets are hard, and more about learning through failure.
	@mass *= 0.25
	@tags = wac corporal bumper capella

	@MODULE[ModuleParachute]
	{
		@semiDeployedDrag *= 1.5
		@fullyDeployedDrag *= 1.0

		// It will open as soon as you ask it to, otherwise Capella will go ballistic
		@minAirPressureToOpen = 0.0
		@clampMinAirPressure = 0.0

		// Takes about 100m to decelerate, but be safe.
		@deployAltitude = 400 
	}

	@MODULE[ModuleCargoPart]
	{
		@packedVolume *= 0.125
		@stackableQuantity *= 8
	}

	@MODULE[ModuleDragModifier]:HAS[#dragCubeName[SEMIDEPLOYED]]
	{
		@dragModifier *= 1.5
	}

	@MODULE[ModuleDragModifier]:HAS[#dragCubeName[DEPLOYED]]
	{
		@dragModifier *= 1.0
	}

	// Remove decouple ability, parachute will appear out of rocket but keep it all safe.
	!fx_gasBurst_white = DELETE
	!sound_decoupler_fire = DELETE
	!MODULE[ModuleDecouple] {}
	
	// Let KSP compute drag cubes because it is rescaled.
	!buoyancyUseCubeNamed = DELETE
	!DRAG_CUBE {}

	// Allow switching color variants.
	MODULE
	{
		name = ModulePartVariants
		baseVariant = Bumper
		useMultipleDragCubes = false
		
		VARIANT
		{
			name = Bumper
			displayName = Bumper
			primaryColor = #ffffff
			secondaryColor = #000000
		}
		VARIANT
		{
			name = WACBlack
			displayName = Wacapella Black
			primaryColor = #000000
			secondaryColor = #ffc400
			TEXTURE
			{
				_Color = #585858
			}
		}
	}
}

// Add suitable fins for Capella are available at start
+PART[tbee-taerobee-fin-small]:AFTER[Spacelines_Tree]
{
	@name = Capella_FinSmall
	@TechRequired = start
	@title = WAC Corporal Fins
	@description = Fins for the WAC Corporal sustainer engine. Three should be enough, though the design said four, less weight is better. Possibly a very slight angle-of-attack of a few degrees would spin the rocket if stability is an issue.
	@bulkheadProfiles = size00,srf
}

+PART[tbee-taerobee-fin-large]:AFTER[Spacelines_Tree]
{
	@name = Capella_FinLarge
	@TechRequired = start
	@title = Tiny Tim Fins
	@description = Fins for the Tiny Tim booster. Three should be enough, though the design said four, less weight is better. Possibly a very slight angle-of-attack of a few degrees would spin the rocket if stability is an issue.
	@bulkheadProfiles = size00,srf
}

@PART[Capella_FinSmall,Capella_FinLarge]:AFTER[Spacelines_Tree]
{
	@TechRequired = start

	// Helpers to scale: 0.5 looked a little too small.
	fin_rescale = 0.75
	
	fin_area_scale = #$fin_rescale$
	@fin_area_scale *= #$fin_rescale$
	@fin_area_scale *= #$fin_rescale$
	
	@rescaleFactor = #$fin_rescale$
	@mass *= #$fin_area_scale$
	@maximum_drag *= #$fin_rescale$
	@minimum_drag *= #$fin_rescale$

	@MODULE[ModuleLiftingSurface]
	{
		@deflectionLiftCoeff *= #$../fin_rescale$
	}

	@MODULE[ModuleCargoPart]
	{
	      	@packedVolume *= #$../fin_area_scale$
		@stackableQuantity *= #$../fin_area_scale$
	}

	!DRAG_CUBE {}

	// Allow switching color variants.
	MODULE
	{
		name = ModulePartVariants
		baseVariant = Bumper
		useMultipleDragCubes = false
		
		VARIANT
		{
			name = Bumper
			displayName = Bumper
			primaryColor = #ffffff
			secondaryColor = #000000
		}
		VARIANT
		{
			name = WACBlack
			displayName = Wacapella Black
			primaryColor = #000000
			secondaryColor = #ffc400
			TEXTURE
			{
				_Color = #787878
			}
		}
	}
}

// Small Tiny Tim suitable for Capella.
+PART[tbee-taerobee-tinytim]:AFTER[Spacelines_Tree]
{
	@name = Capella_TinyTim
	@TechRequired = start
	@title = Tiny Tim Booster
	@description = Tiny Tim booster rocket for the WAC Corporal rocket.
	@bulkheadProfiles = size00,srf

	// Helpers to scale thinner but then longer.
	tinytim_rescale = 0.5
	tinytim_model_scale = 1.75
	
	tinytim_area_scale = #$tinytim_rescale$
	@tinytim_area_scale *= #$tinytim_rescale$
	@tinytim_area_scale *= #$tinytim_model_scale$
	
	tinytim_volume_scale = #$tinytim_rescale$
	@tinytim_volume_scale *= #$tinytim_rescale$	
	@tinytim_volume_scale *= #$tinytim_rescale$
	@tinytim_volume_scale *= #$tinytim_model_scale$

	tinytim_fuel_scale = 1.0 // Tiny Tim only had about 0.6s of thrust!
	tinytim_thrust_scale = 10.0 // Tiny Tim had about 220kN, so 100kN ok. Without its 10kN.

	// Now do the resizing
	@MODEL
	{
		// %scale = 1, #$../tinytim_model_scale$, 1
		%scale = 1, 1.75, 1
	}

	@rescaleFactor = #$tinytim_rescale$
	@rescaleFactor -= 0.02 // Slightly thinner
	@mass *= #$tinytim_area_scale$				// Mostly surface, not volume
	@node_stack_bottom[1,,] *= #$tinytim_model_scale$
	@node_stack_top[1,,] *= #$tinytim_model_scale$

	@RESOURCE,*
	{
		@amount *= #$../tinytim_volume_scale$
		@amount *= #$../tinytim_fuel_scale$
		@maxAmount *= #$../tinytim_volume_scale$
		@maxAmount *= #$../tinytim_fuel_scale$
	}

	@MODULE[ModuleEngines]
	{
		@maxThrust *= #$../tinytim_rescale$
		@maxThrust *= #$../tinytim_rescale$
		@maxThrust *= #$../tinytim_thrust_scale$
	}

	@MODULE[ModuleCargoPart]
	{
		@packedVolume *= #$../tinytim_volume_scale$
	}

	// Allow switching color variants.
	MODULE
	{
		name = ModulePartVariants
		baseVariant = Bumper
		useMultipleDragCubes = false
		
		VARIANT
		{
			name = Bumper
			displayName = Bumper
			primaryColor = #ffffff
			secondaryColor = #000000
		}
		VARIANT
		{
			name = WACBlack
			displayName = Wacapella Black
			primaryColor = #000000
			secondaryColor = #ffc400
			TEXTURE
			{
				_Color = #303030
			}
		}
	}
}

// Suitable decoupler, not quite right, but close enough.
+PART[tbee-taerobee-decoupler]:AFTER[Spacelines_Tree]
{
	@name = Capella_TinyTim_Decoupler
	@TechRequired = start
	@title = Tiny Tim Decoupler
	@description = Decoupler usually placed between Tiny Tim booster and the WAC Corporal engine. For best results stage the WAC Corporal engine with the decoupler, or even stage the Capella engine before it (which is what happened in reality), though it may explode.
	@bulkheadProfiles = size00,srf

	@rescaleFactor = 0.5 // Match tinytim_rescale

	@node_stack_top[1,,] -= 0.02 // Move node slightly down to remove gap
}	

// Tech Tree support
@PART[CapellaExperiment1,CapellaExperiment2,CapellaExperiment3,CapellaParachute_Taerobee,CapellaEngine1,Capella_FinSmall,Capella_TinyTim_Decoupler,Capella_TinyTim,Capella_FinLarge]:AFTER[Spacelines_Tree]
{
	@TechRequired = start
}